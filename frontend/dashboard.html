<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartServe Solutions - Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="navbar">
        <div class="navbar-brand">SmartServe Solutions</div>
        <div class="navbar-menu">
            <a href="#" class="nav-link">Dashboard</a>
            <a href="service-request.html" class="nav-link">New Request</a>
            <button id="logoutBtn" class="btn-logout">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="dashboard-header">
            <h1>Client Dashboard</h1>
            <p id="welcomeMessage">Welcome!</p>
        </div>

        <!-- ===== INTEGRATION POINT 2: Dashboard Data Display ===== -->
        <!-- This section displays service requests fetched from backend -->
        <!-- Data flows: Page Load → fetch /api/requests → Display in table -->
        
        <div class="dashboard-section">
            <div class="section-header">
                <h2>Your Service Requests</h2>
                <a href="service-request.html" class="btn-primary">+ New Request</a>
            </div>
            
            <!-- Status Filter -->
            <div class="filter-section">
                <label for="statusFilter">Filter by Status:</label>
                <select id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="Pending">Pending</option>
                    <option value="Assigned">Assigned</option>
                    <option value="In Progress">In Progress</option>
                    <option value="On Hold">On Hold</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
            </div>
            
            <!-- Loading State -->
            <div id="loadingSpinner" class="loading-spinner" style="display: none;">
                Loading your requests...
            </div>
            
            <!-- Requests Table -->
            <table id="requestsTable" class="requests-table" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Service Type</th>
                        <th>Description</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="requestsBody">
                </tbody>
            </table>
            
            <!-- Empty State -->
            <div id="emptyState" class="empty-state">
                <p>No service requests found. <a href="service-request.html">Create one now</a></p>
            </div>
        </div>
    </div>

    <!-- ===== FRONTEND JAVASCRIPT: API INTEGRATION ===== -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    
    <script>
        /**
         * Dashboard Initialization
         * 
         * On page load:
         * 1. Verify user is authenticated (check token)
         * 2. Fetch service requests from backend
         * 3. Display in table format
         */
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Verify authentication
            if (!localStorage.getItem('token')) {
                window.location.href = 'index.html';
                return;
            }
            
            // Load requests on page load
            await loadServiceRequests();
            
            // Set up filter listener
            document.getElementById('statusFilter').addEventListener('change', async () => {
                await loadServiceRequests();
            });
            
            // Set up logout button
            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('userId');
                window.location.href = 'index.html';
            });
        });
        
        /**
         * INTEGRATION POINT 2: Fetch Service Requests from Backend
         * 
         * Flow:
         * 1. Get JWT token from localStorage
         * 2. Call GET /api/requests with token in header
         * 3. Backend validates token (auth middleware)
         * 4. Backend queries database for user's requests
         * 5. Frontend receives response and displays in table
         */
        async function loadServiceRequests() {
            const loadingSpinner = document.getElementById('loadingSpinner');
            const requestsTable = document.getElementById('requestsTable');
            const emptyState = document.getElementById('emptyState');
            const statusFilter = document.getElementById('statusFilter').value;
            
            loadingSpinner.style.display = 'block';
            requestsTable.style.display = 'none';
            emptyState.style.display = 'none';
            
            try {
                // ===== FRONTEND → BACKEND API CALL =====
                const response = await fetch('http://localhost:5000/api/requests', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 401) {
                    // Token expired, redirect to login
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                    return;
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to load requests');
                }
                
                // ===== PROCESS BACKEND RESPONSE =====
                let requests = data.data || [];
                
                // Apply filter if selected
                if (statusFilter) {
                    requests = requests.filter(req => req.status === statusFilter);
                }
                
                // ===== POPULATE TABLE =====
                populateRequestsTable(requests);
                
                loadingSpinner.style.display = 'none';
                
                if (requests.length > 0) {
                    requestsTable.style.display = 'table';
                } else {
                    emptyState.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error loading requests:', error);
                loadingSpinner.innerHTML = '❌ Error loading requests: ' + error.message;
            }
        }
        
        /**
         * Populate the requests table with data from backend
         * 
         * @param {Array} requests - Array of service request objects
         */
        function populateRequestsTable(requests) {
            const tbody = document.getElementById('requestsBody');
            tbody.innerHTML = ''; // Clear existing rows
            
            requests.forEach(request => {
                const row = document.createElement('tr');
                
                // Format date
                const createdDate = new Date(request.createdAt).toLocaleDateString();
                
                // Determine status color
                const statusClass = 'status-' + request.status.toLowerCase().replace(' ', '-');
                
                row.innerHTML = `
                    <td>${request.id.substring(0, 8)}...</td>
                    <td>${request.serviceType}</td>
                    <td>${request.description.substring(0, 50)}...</td>
                    <td>
                        <span class="badge-priority badge-${request.priority.toLowerCase()}">
                            ${request.priority}
                        </span>
                    </td>
                    <td>
                        <span class="badge-status ${statusClass}">
                            ${request.status}
                        </span>
                    </td>
                    <td>${createdDate}</td>
                    <td>
                        <a href="request-detail.html?id=${request.id}" class="btn-small">View</a>
                        <a href="service-request.html?id=${request.id}" class="btn-small">Edit</a>
                        <button onclick="deleteRequest('${request.id}')" class="btn-small btn-danger">Delete</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        /**
         * Delete a service request
         * Calls DELETE /api/requests/:id
         * 
         * @param {string} requestId - ID of request to delete
         */
        async function deleteRequest(requestId) {
            if (!confirm('Are you sure you want to delete this request?')) {
                return;
            }
            
            try {
                // ===== FRONTEND → BACKEND DELETE CALL =====
                const response = await fetch(`http://localhost:5000/api/requests/${requestId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to delete request');
                }
                
                // Reload table after deletion
                await loadServiceRequests();
                alert('Request deleted successfully');
                
            } catch (error) {
                alert('❌ Error deleting request: ' + error.message);
            }
        }
    </script>
</body>
</html>
